name: Jenkins Shut Up
on:
  issue_comment:
    types: [created]

jobs:
  minimize-jenkins-noise:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Minimize Jenkins Comments
        uses: actions/github-script@v7
        with:
          script: |
            // 1. Get all comments currently on the PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // 2. Filter for comments where the username includes "jenkins"
            const jenkinsComments = comments.filter(c => 
              c.user.login.toLowerCase().includes('kennethstubbings')
            );

            console.log(`Found ${jenkinsComments.length} Jenkins comments.`);

            // 3. If there's more than one, hide everything except the newest one
            if (jenkinsComments.length > 1) {
              // slice(0, -1) ignores the very last (most recent) Jenkins comment
              const oldJenkinsComments = jenkinsComments.slice(0, -1);

              for (const comment of oldJenkinsComments) {
                if (comment.minimized_reason) continue;

                const query = `
                  mutation($id: ID!) {
                    minimizeComment(input: {classifier: OUTDATED, subjectId: $id}) {
                      minimizedComment { isMinimized }
                    }
                  }
                `;
                const variables = { id: comment.node_id };
                
                try {
                  await github.graphql(query, variables);
                  console.log(`Minimized old Jenkins status: ${comment.id}`);
                } catch (error) {
                  console.log(`Failed to hide ${comment.id}: ${error.message}`);
                }
              }
            }
