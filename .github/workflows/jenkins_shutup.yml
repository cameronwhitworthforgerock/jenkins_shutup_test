name: Jenkins Shut Up
on:
  issue_comment:
    types: [created]

jobs:
  minimize-everything:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Minimize All Previous Comments
        uses: actions/github-script@v7
        with:
          script: |
            // 1. Get all comments currently on the PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // 2. If there are previous comments, minimize them
            // comments.length - 1 is the comment that just triggered this action
            if (comments.length > 1) {
              const previousComments = comments.slice(0, -1);

              for (const comment of previousComments) {
                // Skip if it's already minimized
                if (comment.minimized_reason) continue;

                const query = `
                  mutation($id: ID!) {
                    minimizeComment(input: {classifier: OUTDATED, subjectId: $id}) {
                      minimizedComment { isMinimized }
                    }
                  }
                `;
                const variables = { id: comment.node_id };
                
                try {
                  await github.graphql(query, variables);
                  console.log(`Successfully minimized comment: ${comment.id}`);
                } catch (error) {
                  console.log(`Failed to minimize ${comment.id}: ${error.message}`);
                }
              }
            }
